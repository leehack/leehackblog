+++
title = "Python으로 c2dm server 만들기"
date = 2011-12-09T04:25:00Z
updated = 2011-12-09T04:56:20Z
categories = ["Server", "C2DM", "Python", "Push", "Android"]
blogimport = true 
[author]
	name = "Jhinseok LEE"
	uri = "https://plus.google.com/112335443268320557512"
+++

1.&nbsp;<a href="http://code.google.com/intl/ko-KR/android/c2dm/">http://code.google.com/intl/ko-KR/android/c2dm/</a> 에서 c2dm 서비스에 sign-up<br />(gmail account를 새로 만들어서 가입하는 것이 좋다. - 실제로 이 account정보를 클라이언트 및 서버에 모두 넣어야 하고 더구나 서버에는 패스워드정보도 필요하기 때문)<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-HdKsVNq8U3Y/TuHWLJiuniI/AAAAAAAADm8/cOUAaTiV7_o/s1600/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA+2011-12-09+%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE+6.33.53.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="336" src="http://4.bp.blogspot.com/-HdKsVNq8U3Y/TuHWLJiuniI/AAAAAAAADm8/cOUAaTiV7_o/s640/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA+2011-12-09+%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE+6.33.53.png" width="640" /></a></div><br />2. 가입하면 E-mail로 가입한 Account로 서비스가 Enable되었다는 내용의 메일이 옮(보통 하루안에 오고 늦어도 몇일 사이에는 오는 듯)<br /><br />여기까지 준비 완료! 아래는 실제 파이썬 코드 시작!!<br /><br /><pre class="brush:python">import urllib, urllib2<br /><br />class ClientLoginTokenFactory(): <br />    _token = None <br />    <br />    def __init__(self):<br />        self.url = 'https://www.google.com/accounts/ClientLogin'<br />        self.accountType = 'GOOGLE'<br />        self.email = 'c2dm에 가입한 메일주소'<br />        self.password = 'c2dm에 가입한 메일주소의 패스워드'<br />        self.source = 'replstory-replstory-0'<br />        self.service = 'ac2dm'<br />    <br />    def getToken(self):    <br />        if self._token is None:<br />            <br />            # Build payload<br />            values = {'accountType' : self.accountType,<br />                      'Email' : self.email,<br />                      'Passwd' : self.password, <br />                      'source' : self.source, <br />                      'service' : self.service}<br />            <br />            # Build request<br />            data = urllib.urlencode(values)<br />            request = urllib2.Request(self.url, data)<br />            <br />            # Post<br />            response = urllib2.urlopen(request)<br />            responseAsString = response.read()<br />            <br />            # Format response<br />            responseAsList = responseAsString.split('\n')<br />            <br />            self._token = responseAsList[2].split('=')[1]<br />            <br />        return self._token<br />    <br />class C2DM():<br />    <br />    def __init__(self):<br />        self.url = 'https://android.apis.google.com/c2dm/send'<br />        self.clientAuth = None<br />        self.registrationId = None<br />        self.collapseKey = None<br />        self.data = {}<br />        <br />    def sendMessage(self):<br />        if self.registrationId == None or self.collapseKey == None:<br />            return False<br />        <br />        clientAuthFactory = ClientLoginTokenFactory()<br />        self.clientAuth = clientAuthFactory.getToken()<br />        <br />        # Build payload<br />        values = {'registration_id' : self.registrationId,<br />                  'collapse_key' : self.collapseKey}     <br />        <br />        # Loop over any data we want to send<br />        for k, v in self.data.iteritems():            <br />            values['data.' + k] = v<br />        <br />        # Build request<br />        headers = {'Authorization': 'GoogleLogin auth=' + self.clientAuth}        <br />        data = urllib.urlencode(values)<br />        request = urllib2.Request(self.url, data, headers)<br />        <br />        # Post<br />        try:<br />            response = urllib2.urlopen(request)<br />            responseAsString = response.read()<br />            <br />            return responseAsString<br />        except urllib2.HTTPError, e:<br />            print 'HTTPError ' + str(e)<br />            <br />            <br />sender = C2DM()<br />sender.registrationId = 'Android단말기에서 c2dm서버로 부터 받은 고유번호'<br />sender.collapseKey = 1<br />sender.data = {'msg':'test'}<br />response = sender.sendMessage()<br />print response<br /><br /></pre>9,10,79 라인의 정보만 바꾸고 실행하면 c2dm등록된 단말기로 test라는 푸시 메세지가 날아간다.<br /><a href="http://blog.boxedice.com/2010/10/07/android-push-notifications-tutorial/">http://blog.boxedice.com/2010/10/07/android-push-notifications-tutorial/</a>&nbsp;에 있는 예제코드인데 제대로 돌지 않아서 약간의 수정만 했음.<br /><br />이미 눈치 채셨겠지만 실제 사용시에는 78라인부터만 따로 가져가서 원하는 곳에 사용하면 된다. collapseKey를 1로 고정해두고 사용하면 c2dm메세지가 동일한 단말에 동일한 메세지를 계속 적으로 보낼 경우 중간중간 빼먹는 경우가 생긴다. 구글에서 중복된 메세지 전송을 방지하게 넣어둔 코드임. 중복으로 보내는 메세지라도 단말에 꼭 전송이 되어야 하는 메세지라면 collapseKey를 increase하면서 보내는 것이 상책!
